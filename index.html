<script>
    function process_transcript(transcript_text) {
        const lines = transcript_text.trim().split('\n');
        const processed_transcript = [];
        let current_speaker = null;
        let current_text = "";

        let i = 0;
        while (i < lines.length) {
            const line = lines[i];

            if (line.includes('"') && line.includes('(') && line.includes(')') && !isNaN(line[0])) {
                const speaker_name = line.split('"')[1];

                if (current_speaker && current_speaker !== speaker_name && current_text) {
                    processed_transcript.push(`${current_speaker}: ${current_text.trim()}`);
                    current_text = "";
                }

                current_speaker = speaker_name;
                i += 1;

                if (i < lines.length && lines[i].includes("-->")) {
                    i += 1;
                }

                if (i < lines.length) {
                    current_text += " " + lines[i];
                }
            } else {
                current_text += " " + line;
            }

            i += 1;
        }

        if (current_speaker && current_text) {
            processed_transcript.push(`${current_speaker}: ${current_text.trim()}`);
        }

        return processed_transcript.join('\n\n');
    }

    document.getElementById("fileInput").addEventListener("change", function () {
        document.getElementById("fileName").textContent = this.files[0] ? this.files[0].name : "No file selected";
        document.getElementById("processBtn").disabled = !this.files.length;
    });

    document.getElementById("processBtn").addEventListener("click", function () {
        const file = document.getElementById("fileInput").files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const processed = process_transcript(e.target.result);
            
            // **Fixed: Create a proper Blob URL**
            const blob = new Blob([processed], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            
            // **Fix: Set correct `download` attribute**
            const downloadBtn = document.getElementById("downloadBtn");
            downloadBtn.href = url;
            downloadBtn.download = "processed_transcript.txt"; // ✅ Correct filename
            downloadBtn.style.display = "block"; // ✅ Show download button
            
            document.getElementById("status").textContent = "Transcript processed successfully!";
        };

        reader.readAsText(file);
    });

    document.getElementById("themeSelect").addEventListener("change", function () {
        document.body.classList = "theme-" + this.value;
    });
</script>
